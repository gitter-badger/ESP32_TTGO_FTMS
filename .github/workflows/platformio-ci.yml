name: PlatformIO CI

on:
  push:
  pull_request:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:


jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Cache pip
      uses: actions/cache@v2
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    - name: Cache PlatformIO
      uses: actions/cache@v2
      with:
        path: ~/.platformio
        key: ${{ runner.os }}-${{ hashFiles('**/lockfiles') }}
    - name: Set up Python
      uses: actions/setup-python@v2
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade platformio
    - name: Run PlatformIO
      run: |
        #for h in `ls -1 *.h.sample`; do l=${h%.sample}; ln -s $h $l; done
        cat << _end_of_file > include/wifi_mqtt_creds.h
        #ifndef _wifi_mqtt_creds_h_
        #define _wifi_mqtt_creds_h_
        const char* wifi_ssid = "<WIFI NAME>";
        const char* wifi_pass = "<WIFI PASSWD>";
        const char* mqtt_host = "host.org";
        const char* mqtt_user = "user";
        const char* mqtt_pass = "passw0rd";
        const unsigned mqtt_port = 8883;
        #endif
        _end_of_file

        pio run -v -e ESP32_TTGO_DISPLAY_TFT_eSPI
